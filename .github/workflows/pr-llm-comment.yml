name: PR LLM Comment

on:
  workflow_run:
    workflows: ["PR LLM Analyze"]
    types: [completed]

permissions:
  actions: read
  pull-requests: write
  contents: read

jobs:
  comment:
    runs-on: ubuntu-latest

    steps:
      - name: Skip if analyze failed
        if: ${{ github.event.workflow_run.conclusion != 'success' }}
        run: exit 0

      - name: Extract PR info and skip forks
        id: meta
        uses: actions/github-script@v7
        with:
          script: |
            const prs = context.payload.workflow_run.pull_requests || [];
            if (prs.length === 0) {
              core.setFailed('No PR found');
              return;
            }

            const pr = prs[0];

            if (pr.head.repo.fork) {
              core.notice('PR from fork - skipping comment.');
              core.setOutput('skip', 'true');
              return;
            }

            core.setOutput('skip', 'false');
            core.setOutput('pr_number', String(pr.number));
            // workflow_run payload can omit base repo details, so fall back to the current repo
            const repoFull = pr?.base?.repo?.full_name || `${context.repo.owner}/${context.repo.repo}`;
            core.setOutput('repo_full', repoFull);

      - name: Stop if skipped
        if: ${{ steps.meta.outputs.skip == 'true' }}
        run: exit 0

      - name: Find review artifact id
        id: artifact
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const runId = context.payload.workflow_run.id;
            const name = 'pr-llm-review';

            // Retry a few times in case of eventual consistency
            for (let attempt = 1; attempt <= 6; attempt++) {
              const res = await github.rest.actions.listWorkflowRunArtifacts({
                owner,
                repo,
                run_id: runId,
                per_page: 100,
              });

              const names = res.data.artifacts.map(a => a.name).join(', ');
              core.info(`Attempt ${attempt}: artifacts for run ${runId}: ${names || '(none)'}`);

              const found = res.data.artifacts.find(a => a.name === name);
              if (found) {
                core.setOutput('artifact_id', String(found.id));
                core.info(`Found artifact '${name}' with id ${found.id}`);
                return;
              }

              // wait 5s then retry
              await new Promise(r => setTimeout(r, 5000));
            }

            core.setFailed(`Artifact 'pr-llm-review' not found for run ${runId}`);

      - name: Download and unzip review artifact
        run: |
          set -euo pipefail
          mkdir -p artifact
          ARTIFACT_ID='${{ steps.artifact.outputs.artifact_id }}'
          echo "Downloading artifact id: ${ARTIFACT_ID}"

          curl -L \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/artifacts/${ARTIFACT_ID}/zip" \
            -o artifact.zip

          unzip -o artifact.zip -d artifact
          ls -la artifact

      - name: Post comment to PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('artifact/review.md', 'utf8');

            const pr_number = Number('${{ steps.meta.outputs.pr_number }}');
            const [owner, repo] = '${{ steps.meta.outputs.repo_full }}'.split('/');

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr_number,
              body
            });
