name: PR LLM Comment

on:
  workflow_run:
    workflows: ["PR LLM Analyze"]
    types: [completed]

permissions:
  actions: read
  pull-requests: write
  contents: read

jobs:
  comment:
    runs-on: ubuntu-latest

    steps:
      - name: Skip if analyze failed
        if: ${{ github.event.workflow_run.conclusion != 'success' }}
        run: exit 0

      - name: Extract PR info and skip forks
        id: meta
        uses: actions/github-script@v7
        with:
          script: |
            const prs = context.payload.workflow_run.pull_requests || [];
            if (prs.length === 0) core.setFailed('No PR found');

            const pr = prs[0];

            if (pr.head.repo.fork) {
              core.notice('PR from fork - skipping comment.');
              core.setOutput('skip', 'true');
              return;
            }

            core.setOutput('skip', 'false');
            core.setOutput('pr_number', String(pr.number));
            core.setOutput('repo_full', pr.base.repo.full_name);

      - name: Stop if skipped
        if: ${{ steps.meta.outputs.skip == 'true' }}
        run: exit 0

      - name: Download review artifact
        uses: actions/download-artifact@v4
        with:
          name: pr-llm-review
          run-id: ${{ github.event.workflow_run.id }}
          path: artifact

      - name: Post comment to PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('artifact/review.md', 'utf8');

            const pr_number = Number('${{ steps.meta.outputs.pr_number }}');
            const [owner, repo] = '${{ steps.meta.outputs.repo_full }}'.split('/');

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr_number,
              body
            });
